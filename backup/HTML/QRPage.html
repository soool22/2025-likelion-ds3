{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>DDAL-LANG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="{% static 'css/QRPage.css' %}" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <!-- main 요소로 교체 (또는 CSS에서 #main 선택자로 변경해도 됨) -->
    <main>

        <!-- 인라인 style 제거 (CSS에서 크기 제어) -->
        <div id="reader" aria-label="QR 스캐너"></div>
        <div id="status">카메라를 켜고 QR을 스캔해주세요.</div>
    </main>

    <script>
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 }
        );

        // 페이지 로드 시 스캐너 시작
        window.onload = function() {
            html5QrcodeScanner.render(onScanSuccess);
        };

        function onScanSuccess(decodedText) {
            const statusEl = document.getElementById("status");
            statusEl.textContent = "QR 인식됨: " + decodedText;
            console.log("Scanned QR:", decodedText);

            let token;
            try {
                const urlObj = new URL(decodedText, window.location.origin);
                token = urlObj.searchParams.get("token");
                if (!token) throw new Error("토큰이 없습니다.");
            } catch (err) {
                console.error("Invalid QR URL:", err);
                statusEl.textContent = "QR 데이터가 올바르지 않습니다.";
                html5QrcodeScanner.clear();
                return;
            }

            const apiUrl = "/visit_rewards/visit/?token=" + token + "&test=1";

            fetch(apiUrl)
                .then(res => {
                    if (!res.ok) {
                        throw new Error("네트워크 응답 실패: " + res.status);
                    }
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        return res.json();
                    } else {
                        throw new Error("서버 응답이 JSON이 아닙니다.");
                    }
                })
                .then(data => {
                    if (data.status === "ok") {
                        // 기본 메시지
                        statusEl.innerHTML =
                            `[${data.store_name}] 방문을 환영합니다! (누적 방문 ${data.total_visits}회)<br>` +
                            `${data.points_earned}포인트가 적립되었습니다!` +
                            `<br><a href="/visit_rewards/rewards/">내 리워드 보기</a>`;

                        // 누적 금액 챌린지가 있고 아직 완료하지 않은 경우에만 링크 표시
                        if (data.has_amount_mission && !data.completed_amount_mission) {
                            statusEl.innerHTML += `<br><a href="/stores/store-detail/${data.store_id}/">누적 금액 받자!</a>`;
                        }

                    } else if (data.status === "already_visited") {
                        statusEl.textContent = "이미 방문한 QR입니다. 내일 다시 시도해주세요.";
                    } else {
                        statusEl.textContent = "인증 실패";
                    }
                })
                .catch(err => {
                    console.error("Fetch error:", err);
                    statusEl.textContent = "인증 중 오류가 발생했습니다.";
                })
                .finally(() => {
                    html5QrcodeScanner.clear(); // 항상 카메라 종료
                });
        }
    </script>
</body>
</html>
