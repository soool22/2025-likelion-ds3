{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DDAL-LANG</title>
        <link rel="stylesheet" href="{% static 'css/OwnerStoreRegistration.css'%}" />
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7e2e7e424a6b7b49922a592ab416600c&libraries=services"></script>
    </head>
    <body>
        <main>
            <div id="container">
                <header>
                    <p> </p>
                    <p id="title">가게 등록</p>
                    <p> </p>
                </header>
                <div id="containerBox">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="text" name="name" placeholder="가게 이름" class="inputBox"
               id="id_name" value="{{ form.instance.name|default_if_none:'' }}"/>
                        <div id="searchBox">
                            <input  class="search" placeholder="주소" type="text" name="address"
                 id="id_address" value="{{ form.instance.address|default_if_none:'' }}" />
                            <button type="button" id="btn-search"><img id="searchIcon" src="{% static 'img/search.svg'%}" /></button>
                            <button class="realSearchBtn"></button>
                        </div>
                        <input type="hidden" name="latitude" id="id_latitude" value="{{ form.latitude.value|default_if_none:'' }}">
                        <input type="hidden" name="longitude" id="id_longitude" value="{{ form.longitude.value|default_if_none:'' }}">

                        <div id="map"></div>
                        <div id="nowLocationBox">
                            <img id="locationIcon" src="{% static 'img/locationgray.svg'%}"/>
                            <button type="button" id="btn-current" class="locationBtn">현위치 가져오기</button>
                        </div>
                        <input type="text" name="gu_name" placeholder="구 이름"
               class="inputBox" id="id_gu_name"
               value="{{ form.instance.gu_name|default_if_none:'' }}"/>
                        <div class="box">
                            <p class="boxTitle">카테고리</p>
                            <div class="boxContent">
                                {{ form.category }}
                            </div>
                        </div>
                        <input type="text" name="number" placeholder="가게 전화"
               class="inputBox" id="id_number"
               value="{{ form.instance.number|default_if_none:'' }}"/>
                        <div class="box">
                            <p class="boxTitle">오픈 시간</p>
                            <div class="boxContent">
                                <input type="time" name="open_time" class="timeStyle" id="id_open_time"
                   value="{{ form.instance.open_time|default_if_none:'' }}"/>
                            </div>
                        </div>
                        <div class="box">
                            <p class="boxTitle">마감 시간</p>
                            <div class="boxContent">
                                <input type="time" name="close_time" class="timeStyle" id="id_close_time"
                   value="{{ form.instance.close_time|default_if_none:'' }}" />
                            </div>
                        </div>
                        <input type="password" name="secret_code" placeholder="점주 코드"
               class="inputBox" id="id_secret_code"
               value="{{ form.instance.secret_code|default_if_none:'' }}"/>
                        <button type="submit" class="btn" id="btn">확인</button>
                        {% if form.errors %}
                        <div style="color:#d00;margin-top:8px;">{{ form.errors }}</div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </main>
        <script>
        var mapContainer = document.getElementById('map');
        var mapOption = { 
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        var marker = new kakao.maps.Marker({ map: map, draggable: true });
        var geocoder = new kakao.maps.services.Geocoder();

        // 현재 위치 버튼
        document.getElementById('btn-current').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var locPosition = new kakao.maps.LatLng(lat, lng);
                    map.setCenter(locPosition);
                    marker.setPosition(locPosition);
                    document.getElementById('id_latitude').value = lat;
                    document.getElementById('id_longitude').value = lng;
                    
                    geocoder.coord2Address(lng, lat, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            document.getElementById('id_address').value = result[0].address.address_name;
                            // 구 이름 자동 업데이트는 사용자가 입력하지 않은 경우만
                            var gu = result[0].address.region_2depth_name;
                            var guInput = document.getElementById('id_gu_name');
                            if (!guInput.value) {
                                guInput.value = gu;
                            }
                        }
                    });
                });
            }
        });

        // 지도 클릭 이벤트
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var latlng = mouseEvent.latLng;
            marker.setPosition(latlng);
            document.getElementById('id_latitude').value = latlng.getLat();
            document.getElementById('id_longitude').value = latlng.getLng();

            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    document.getElementById('id_address').value = result[0].address.address_name;
                    var gu = result[0].address.region_2depth_name;
                    var guInput = document.getElementById('id_gu_name');
                    if (!guInput.value) {
                        guInput.value = gu;
                    }
                }
            });
        });

        // 마커 드래그 이벤트
        kakao.maps.event.addListener(marker, 'dragend', function() {
            var latlng = marker.getPosition();
            document.getElementById('id_latitude').value = latlng.getLat();
            document.getElementById('id_longitude').value = latlng.getLng();

            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    document.getElementById('id_address').value = result[0].address.address_name;
                    var gu = result[0].address.region_2depth_name;
                    var guInput = document.getElementById('id_gu_name');
                    if (!guInput.value) {
                        guInput.value = gu;
                    }
                }
            });
        });

        // 주소 검색
        document.getElementById('btn-search').addEventListener('click', function() {
            var address = document.getElementById('id_address').value;
            if(address){
                geocoder.addressSearch(address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        var loc = new kakao.maps.LatLng(result[0].y, result[0].x);
                        map.setCenter(loc);
                        marker.setPosition(loc);
                        document.getElementById('id_latitude').value = result[0].y;
                        document.getElementById('id_longitude').value = result[0].x;
                        var gu = result[0].address.region_2depth_name;
                        var guInput = document.getElementById('id_gu_name');
                        if (!guInput.value) {
                            guInput.value = gu;
                        }
                    } else {
                        alert("주소를 찾을 수 없습니다.");
                    }
                });
            }
        });
        </script>
    </body>
    <script src="{% static 'js/OwnerRegistaration.js'%}"></script>
</html>