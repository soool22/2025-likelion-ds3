{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DDAL-LANG</title>
        <link rel="stylesheet" href="{% static 'css/StoreDetailPage.css'%}" />
    </head>
    <body>
        <main>
            <div id="container">
                <header>
                    <div id="headerBox">
                        <a href='{% url "stores:public-store-list" %}'>
                            <img id="sideClick" src="{% static 'img/leftside.svg'%}"/>
                        </a>
                        <button id="favorite-btn" data-store="{{ store.id }}">ì°œí•˜ê¸°</button>
                        {% if is_favorite %}
                        <img 
                            id="star" 
                            src="{% static 'img/starpicked.svg' %}" 
                            data-default="{% static 'img/star.svg' %}" 
                            data-picked="{% static 'img/starpicked.svg' %}"
                        />
                        {% else %}
                        <img 
                            id="star" 
                            src="{% static 'img/star.svg' %}" 
                            data-default="{% static 'img/star.svg' %}" 
                            data-picked="{% static 'img/starpicked.svg' %}"
                        />
                        {% endif %}
                    </div>
                </header>
                <div id="containerBox">
                    {% if store.image %}
                    <a href="{{ store.image.url }}" target="_blank">
                        <img id="storeImg" src="{{ store.image.url }}"/>
                    </a>
                    {% else %}
                        <img id="storeImg" src="{% static 'img/default_store.png' %}"/>
                    {% endif %}
                    <div id="storeInfoBox">
                        <p id="category">
                            {% for category in store.category.all %}
                                {{ category.name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p id="storeName">{{ store.name }}</p>
                        <a href="{% url 'reviews:review-create' store.id %}">
                            <div id="scoreBox">
                                <a id="scoreSmallBox" href="{% url 'reviews:review-list' store.id %}">
                                    <img id="starScore" src="{% static 'img/starpicked.svg'%}"/>
                                    <p id="realScore">{{ store.rating|floatformat:1 }}</p>
                                    <p id="scoreCount">({{ store.reviews.count }})</p>
                                </a>
                            </div>
                        </a>
                        <p id="address">{{ store.address }} 
                            {% if store.distance %}
                                    ğŸ“{{ store.distance }}
                            {% endif %}
                        </p>
                        <p id="call">
                            {% if store.number %}
                                <a href="tel:{{ store.number }}">{{ store.number }}</a>
                            {% else %}
                                ì •ë³´ ì—†ìŒ
                            {% endif %}
                        </p>
                        {% if store.open_time and store.close_time %}
                        <p id="hours">{{ store.open_time|time:"H:i" }} ~ {{ store.close_time|time:"H:i" }} 
                            {% if store.is_open %}
                                (ì˜ì—… ì¤‘)
                            {% else %}
                                (ì˜ì—… ì¢…ë£Œ)
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                    <div id="buttonBox">
                        <button id="certificationBtn" type="button">
                            <div class="btnInnerBox">
                                <img class="btnIcon" src="{% static 'img/qrwhite.svg'%}"/>
                                <p class="btnText1">QR ì½”ë“œë¡œ ë°©ë¬¸ ì¸ì¦í•˜ê¸°</p>
                            </div>
                        </button>
                        <button id="reviewBtn" type="button">
                            <div class="btnInnerBox">
                                <img class="btnIcon" src="{% static 'img/reviewwhite.svg'%}"/>
                                <p class="btnText1">ë¦¬ë·° ì‘ì„±í•˜ê¸°</p>
                            </div>
                        </button>
                        <button id="aiBtn" type="button">
                            <div class="btnInnerBox">
                                <img class="btnIcon" src="{% static 'img/aigray.svg'%}"/>
                                <p class="btnText2">AI ë¦¬ë·° ìš”ì•½ ë³´ê¸°</p>
                            </div>
                        </button>
                        
                        <div id="aiReview">
                            {% if ai_summary %}
                            <div class="summaryBox">
                                <p class="summaryTitle">í‚¤ì›Œë“œ ìš”ì•½</p>
                                <p class="summaryContent">
                                    {% for kw in review_keywords %}
                                        {{ kw }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                            <div class="summaryBox">
                                <p class="summaryTitle">ìš”ì•½</p>
                                <p class="summaryContent">{{ ai_summary }}</p>
                            </div>
                            <div class="summaryBox">
                                <p class="summaryTitle">ì›ë¬¸ ì¼ë¶€</p>
                                <p class="summaryTitle">{{ snippet }}</p>
                            </div>
                            {% else %}
                            <p class="summaryContent">ë¦¬ë·° ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endif %}
                        </div>
                        {% if messages %}
                        <script>
                        {% for message in messages %}
                            alert('{{ message }}');
                        {% endfor %}
                        </script>
                        {% endif %}
                    </div>
                </div>
                <div class="containerContent">
                    <div class="containerTitle">ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€</div>
                    <div class="containerSmallContentBox">
                        {% for mission in missions %}
                        <p class="containerSmallContent">
                            {{ mission.title }}
                            {% comment %} {{ mission.description }}<br/>
                            {{ mission.mission_type.name }} - {{ mission.target_value|floatformat:0|intcomma }}{{ mission.mission_type.unit }}<br/>
<<<<<<< HEAD
                            ë³´ìƒ: {{ mission.reward_description }}<br/>
                            {{ mission.start_date|date:"Y-m-d H:i" }} ~ {{ mission.end_date|date:"Y-m-d H:i" }}<br/> {% endcomment %}
=======
                            
                            <!--################ë³´ìƒ################-->
                            {% if mission.reward_type == "POINT" %}
                                í¬ì¸íŠ¸: {{ mission.reward_points }}ì  
                            {% elif mission.reward_type == "CUSTOM" %}
                                ì§ì ‘ ì…ë ¥ ë³´ìƒ: {{ mission.reward_description }}
                            {% endif %}
                            <br/>
                            <!---####################################-->

                            {{ mission.start_date|date:"Y-m-d H:i" }} ~ {{ mission.end_date|date:"Y-m-d H:i" }}<br/>
>>>>>>> d86a2cf7061cc5da3c1e6c7b553c159275c2e03d

                            {% comment %} {% if mission.mission_type.key == 'amount' and user_can_access_amount %}
                            <a href="{% url 'missions:update-amount' mission.id %}">ëˆ„ì  ê¸ˆì•¡ ì…ë ¥</a>
                            {% endif %} {% endcomment %}
                        </p>
                        {% empty %}
                        <p class="containerSmallContent">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="containerContent">
                    <div class="containerTitle">ìƒí’ˆ/ë©”ë‰´</div>
                    <div class="containerSmallContentBox">
                        {% for product in products %}
                        <div class="containerTinyContentBox">
                            <div class="menuSmallBox">
<<<<<<< HEAD
                            {% comment %} <div class="mainMenu">ëŒ€í‘œ</div> {% endcomment %}
=======
                            <div class="mainMenu">
                                {% if product.is_main %}
                                    ëŒ€í‘œ
                                {% endif %}
                            </div>
>>>>>>> d86a2cf7061cc5da3c1e6c7b553c159275c2e03d
                            <p class="containerSmallContent">{{ product.name }}</p>
                            </div>
                            <p class="price">{{ product.price|floatformat:0|intcomma }}</p>
                            {% comment %} <p class="price">{{ product.description }}</p> {% endcomment %}
                            {% comment %} {% if product.image %}
                            <a href="{{ product.image.url }}" target="_blank">
                                <img src="{{ product.image.url }}" alt="{{ product.name }} ì´ë¯¸ì§€" width="150" height="150">
                            </a>
                            {% endif %} {% endcomment %}
                        </div>
                        {% empty %}
                        <p class="containerSmallContent">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div id="tapBar">
                <a class="tapBarBox" href="{% url 'home:main'%}">
                    <img class="tapBarIcon" src="{% static 'img/home.svg'%}" alt="í™ˆ ì„ íƒ ì•„ì´ì½˜" />
                    <p class="tapBarLabel">í™ˆ</p>
                </a>
                <a class="tapBarBox" href="{% url 'stores:store-search' %}">
                    <img class="tapBarIcon" src="{% static 'img/searchpicked.svg'%}" alt="ê°€ê²Œ ê²€ìƒ‰ ì•„ì´ì½˜" />
                    <p class="tapBarLabel picked">ê°€ê²Œ ê²€ìƒ‰</p>
                </a>
                <a class="tapBarBox" href="{% url 'accounts:favorite_stores' %}">
                    <img class="tapBarIcon" src="{% static 'img/intereststore.svg'%}" alt="ê´€ì‹¬ ë§¤ì¥ ì•„ì´ì½˜" />
                    <p class="tapBarLabel">ê´€ì‹¬ ë§¤ì¥</p>
                </a>
                <a class="tapBarBox" href="{% url 'accounts:mypage' %}">
                    <img class="tapBarIcon" src="{% static 'img/myinfo.svg'%}" alt="ë‚´ ì •ë³´ ì•„ì´ì½˜" />
                    <p class="tapBarLabel">ë‚´ ì •ë³´</p>
                </a>
            </div>
        </main>

        <script>
        document.addEventListener('DOMContentLoaded', function () {
        const favBtn  = document.getElementById('favorite-btn');
        const starImg = document.getElementById('star');
        if (!favBtn || !starImg) return;

        const storeId     = favBtn.dataset.store;
        const KEY         = 'fav_store_' + storeId;     // e.g. fav_store_3
        const SRC_DEFAULT = starImg.dataset.default;    // data-defaultì—ì„œ ì½ìŒ
        const SRC_PICKED  = starImg.dataset.picked;     // data-pickedì—ì„œ ì½ìŒ

        // ---------- A) ì´ˆê¸° ìƒíƒœ ë³µì› (localStorage ìš°ì„ ) ----------
        const saved = localStorage.getItem(KEY); // '1' or '0' or null
        if (saved === '1') {
            starImg.src = SRC_PICKED;
            favBtn.textContent = 'â™¥ ì°œ í•´ì œ';
        } else if (saved === '0') {
            starImg.src = SRC_DEFAULT;
            favBtn.textContent = 'â™¡ ì°œí•˜ê¸°';
        } // nullì´ë©´ ì„œë²„ê°€ ë Œë”í•œ ê¸°ë³¸ ìƒíƒœë¥¼ ê·¸ëŒ€ë¡œ ë‘ 

        // ---------- B) ë³„ í´ë¦­ ì‹œ â†’ ë²„íŠ¼ í´ë¦­ ìœ„ì„ ----------
        starImg.addEventListener('click', () => favBtn.click());

        // ---------- C) ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ í† ê¸€ + localStorage ë™ê¸°í™” ----------
        let busy = false;
        favBtn.addEventListener('click', function () {
            if (busy) return;
            busy = true;

            fetch("{% url 'accounts:toggle_favorite' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `store_id=${encodeURIComponent(storeId)}`
            })
            .then(res => res.json())
            .then(data => {
            if (data.status === 'added') {
                starImg.src = SRC_PICKED;
                favBtn.textContent = 'â™¥ ì°œ í•´ì œ';
                localStorage.setItem(KEY, '1');
            } else if (data.status === 'removed') {
                starImg.src = SRC_DEFAULT;
                favBtn.textContent = 'â™¡ ì°œí•˜ê¸°';
                localStorage.setItem(KEY, '0');
            } else {
                alert('ì°œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            })
            .catch(() => {
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => { busy = false; });
        });
        });
        </script>
    </body>
    <script src="{% static 'js/StoreDetailPage.js'%}"></script>
</html>