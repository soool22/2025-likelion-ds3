{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>위치 설정</title>

    <!-- 카카오맵 SDK -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7e2e7e424a6b7b49922a592ab416600c&libraries=services,clusterer,drawing"></script>
    
    <!-- ################## CSS ##################-->
    <style>
        #map { width: 100%; height: 400px; margin-top: 10px; }
        .input-group { margin: 10px 0; }
        label { display: block; margin-bottom: 4px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 6px; }
        button { margin-top: 10px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h2>현재 위치 설정</h2>

    <form method="POST" action="{% url 'accounts:user_location' %}">
        {% csrf_token %}

        <div class="input-group">
            <label for="address">주소</label>
            <input type="text" id="address" name="address" value="{{ saved_address }}" placeholder="도로명, 지번">
            <button type="button" id="search-address">주소 검색</button>
            <button type="button" id="current-location">현재 위치 가져오기</button>
        </div>

        <input type="hidden" name="latitude" id="latitude" value="{{ saved_lat }}">
        <input type="hidden" name="longitude" id="longitude" value="{{ saved_lng }}">
        <input type="hidden" name="gu_name" id="gu_name" value="{{ saved_gu }}">

        <div id="map"></div>

        <button type="submit">위치 저장</button>
    </form>
    
<!-- ################## JS ##################-->
    <script>
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(
                {{ saved_lat|default:"37.5665" }},
                {{ saved_lng|default:"126.9780" }}
            ),
            level: 3
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        var geocoder = new kakao.maps.services.Geocoder();
        var marker = new kakao.maps.Marker({
            map: map,
            position: map.getCenter()
        });

        // 지도 클릭 시 마커 이동 & 주소 업데이트
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var latlng = mouseEvent.latLng;
            marker.setPosition(latlng);
            map.setCenter(latlng);
            document.getElementById('latitude').value = latlng.getLat();
            document.getElementById('longitude').value = latlng.getLng();

            // 좌표 -> 주소 변환 (Reverse Geocoding)
            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var address = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                    document.getElementById('address').value = address;

                    // 구 추출
                    var gu = address.split(" ")[1]; 
                    document.getElementById('gu_name').value = gu;
                }
            });
        });

        // 주소 검색
        document.getElementById('search-address').addEventListener('click', function() {
            var address = document.getElementById('address').value;
            geocoder.addressSearch(address, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var lat = result[0].y;
                    var lng = result[0].x;
                    var coords = new kakao.maps.LatLng(lat, lng);

                    marker.setPosition(coords);
                    map.setCenter(coords);

                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;

                    // 구 추출
                    var gu = result[0].address_name.split(" ")[1];
                    document.getElementById('gu_name').value = gu;
                } else {
                    alert('주소를 찾을 수 없습니다.');
                }
            });
        });

        // 현재 위치 가져오기
        document.getElementById('current-location').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var coords = new kakao.maps.LatLng(lat, lng);

                    marker.setPosition(coords);
                    map.setCenter(coords);

                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;

                    geocoder.coord2Address(lng, lat, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            var address = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                            document.getElementById('address').value = address;
                            var gu = address.split(" ")[1];
                            document.getElementById('gu_name').value = gu;
                        }
                    });
                }, function(error) {
                    alert('위치 정보를 가져올 수 없습니다.');
                });
            } else {
                alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
            }
        });
    </script>
</body>
</html>
