{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메인 페이지</title>
    <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f9f9f9; }
    h2 { margin-top: 32px; margin-bottom: 8px; }
    .store-section { margin-bottom: 32px; }
    .store-cards { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px; }
    .store-card { flex: 0 0 180px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-shadow: 1px 1px 4px rgba(0,0,0,0.1); text-align: center; background: #fff; }
    .store-card h3 { font-size: 1em; margin: 8px 0; }
    .store-card p { font-size: 0.85em; margin: 4px 0; }
    .store-cards::-webkit-scrollbar { height: 6px; }
    .store-cards::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    a { text-decoration: none; color: #007BFF; }
    a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h2>메인 페이지</h2>
    <hr>

    {% if request.user.is_authenticated %}
        {{ request.user.nickname }}({{ request.user.username }})님 환영합니다.<br><br>
        <a href='{% url 'accounts:start-page' %}'>소비자/점주 전환</a><br>  
        <a href="{% url 'accounts:logout' %}">로그아웃</a><br><br><hr>
        <a href="{% url 'accounts:mypage' %}">마이페이지 | </a>
        <a href="{% url 'accounts:favorite_stores' %}">관심 가게 | </a>
        <a href="{% url 'missions:my-mission' %}">내 챌린지 | </a>
        <a href="{% url 'visit_rewards:my_character' %}">내 캐릭터</a>
    {% else %}
        <a href="{% url 'accounts:login' %}">로그인</a>
        <a href="{% url 'accounts:signup' %}">회원가입</a>
    {% endif %}
    <hr>

    <!-- 구 선택 -->
    <div>
        <a href="{% url 'accounts:user_location' %}">
            {% if user_location and user_location.gu_name %}
                {{ user_location.gu_name }}▼
            {% else %}
                위치 설정
            {% endif %}
        </a>
    </div>

    {% if gu_name %}
    <!-- 방문자 랭킹 -->
    <div class="store-section">
        <h2>방문자 랭킹</h2>
        <div class="store-cards">
            {% for store in top_visits %}
                <div class="store-card">
                    <h3><a href="{% url 'stores:store-detail' store.id %}">{{ store.name }}</a></h3>
                    <p>{% for c in store.category.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
                    {% if store.open_time and store.close_time %}
                        <p>{{ store.open_time|time:"H:i" }} ~ {{ store.close_time|time:"H:i" }}
                        {% if store.is_open %}(영업 중){% else %}(영업 종료){% endif %}</p>
                    {% else %}
                        <p>영업시간 미정</p>
                    {% endif %}
                    {% if store.distance %}
                        <p>거리: {{ store.distance }}</p>
                    {% else %}
                        <p>거리 정보 없음</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <a href="{% url 'stores:popular-store-list' %}">더보기</a>
    </div>

    <!-- 리뷰 베스트 -->
    <div class="store-section">
        <h2>리뷰 베스트</h2>
        <div class="store-cards">
            {% for store in review_best %}
                <div class="store-card">
                    <h3><a href="{% url 'stores:store-detail' store.id %}">{{ store.name }}</a></h3>
                    <p>{% for c in store.category.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
                    {% if store.open_time and store.close_time %}
                        <p>{{ store.open_time|time:"H:i" }} ~ {{ store.close_time|time:"H:i" }}
                        {% if store.is_open %}(영업 중){% else %}(영업 종료){% endif %}</p>
                    {% else %}
                        <p>영업시간 미정</p>
                    {% endif %}
                    {% if store.distance %}
                        <p>거리: {{ store.distance }}</p>
                    {% else %}
                        <p>거리 정보 없음</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <a href="{% url 'stores:review-best-list' %}">더보기</a>
    </div>

    <!-- AI 추천 가게 -->
    <div class="store-section">
        <h2>AI 추천 가게</h2>
        <div class="store-cards">
            {% if recommended_stores %}
                {% for store in recommended_stores %}
                    <div class="store-card">
                        <h3><a href="{% url 'stores:store-detail' store.id %}">{{ store.name }}</a></h3>
                        <p>{% for c in store.category.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
                        {% if store.open_time and store.close_time %}
                            <p>{{ store.open_time|time:"H:i" }} ~ {{ store.close_time|time:"H:i" }}
                            {% if store.is_open %}(영업 중){% else %}(영업 종료){% endif %}</p>
                        {% else %}
                            <p>영업시간 미정</p>
                        {% endif %}
                        {% if store.distance %}
                            <p>거리: {{ store.distance }}</p>
                        {% else %}
                            <p>거리 정보 없음</p>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>추천 가게를 불러오는 중입니다...</p>
            {% endif %}
        </div>
        <a href="{% url 'stores:public-store-list' %}">더보기</a>
    </div>

    <!-- 오늘의 인기 챌린지 -->
    <h3>오늘의 인기 챌린지</h3>
    {% if rankings %}
    <ol>
        {% for r in rankings %}
            <li>
                <a href="{% url 'stores:store-detail' r.mission.store.id %}">{{ r.mission.store.name }}</a>
                <br/>{{ r.mission.title }} ▶ 참여자 {{ r.participant_count }}명
            </li>
        {% endfor %}
    </ol>
    {% else %}
        <p>오늘의 인기 챌린지가 없습니다.</p>
    {% endif %}

    <!-- 가게 검색 -->
    <nav>
        <a href="{% url 'stores:store-search' %}">가게 검색</a>
    </nav>
    {% endif %}
</body>
</html>
