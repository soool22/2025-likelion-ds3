{% load static %}
{% load humanize %} {# intcomma 숫자 읽기 쉽게 변환 가능 #}

<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>DDAL-LANG</title>
        <link rel="stylesheet" href="{% static 'css/OwnerStoreRegistration.css'%}" />
    </head>
    <body> 
        <main>
            <div id="container">
                <header>
                    <a href="{% url 'products:product-list' store.id %}" id="change">
                        <img src="{% static 'img/leftside.svg'%}" class="sideClick"/>
                    </a>
                    <p id="title">상품 수정</p>
                    <p></p>
                </header>
                <div id="containerBox">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- 상품명 -->
                        <input type="text" name="name" id="id_name" placeholder="상품명"
                            class="inputBox"
                            value="{{ form.name.value|default_if_none:'' }}" />

                        <!-- 가격 -->
                        <input type="text" name="price" id="id_price" placeholder="가격"
                            class="inputBox"
                            value="{{ form.price.value|default_if_none:'' }}" />

                        <!-- 상품 설명 -->
                        <input type="text" name="description" id="id_description" placeholder="상품 설명"
                            class="inputBox"
                            value="{{ form.description.value|default_if_none:'' }}" />

                        <!-- 대표 상품 -->
                        <label class="checkboxLabel">
                            <input type="checkbox" name="is_main" id="id_is_main"
                                {% if form.is_main.value %}checked{% endif %} />
                            대표 상품 (1개만 가능합니다)
                        </label>

                        <button type="submit" class="btn" id="btn">확인</button>
                    </form>
                </div>
            </div>
        </main>
    </body>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form');
        const btn  = document.getElementById('btn');

        // 입력 요소들
        const nameInput  = document.getElementById('id_name');
        const priceInput = document.getElementById('id_price');
        const descInput  = document.getElementById('id_description');
        const mainLabel  = document.querySelector('.checkboxLabel');
        const mainCheck  = mainLabel ? mainLabel.querySelector('input[type="checkbox"]') : null;

        // 값 있는지 확인
        const hasValue = (el) => el && el.value.trim() !== '';

        // 필드 .active 토글
        const toggleActive = (el) => {
            if (!el) return;
            el.classList.toggle('active', hasValue(el));
        };

        // 버튼 활성화 조건: 상품명/설명/가격 모두 채움
        const updateButton = () => {
            const ok = hasValue(nameInput) && hasValue(descInput) && hasValue(priceInput);
            btn.classList.toggle('active', ok);
            btn.dataset.enabled = ok ? '1' : '0';
        };

        // 가격 숫자만 입력(실시간)
        const sanitizePrice = () => {
            if (!priceInput) return;
            const start = priceInput.selectionStart;
            const end   = priceInput.selectionEnd;
            const before = priceInput.value;

            // 숫자만 남김
            let onlyDigits = before.replace(/[^\d]/g, '');
            if (onlyDigits.length > 1) {
                onlyDigits = String(parseInt(onlyDigits, 10) || '');
            }

            if (before !== onlyDigits) {
                priceInput.value = onlyDigits;
                const delta = before.length - onlyDigits.length;
                priceInput.setSelectionRange(Math.max(0, start - delta), Math.max(0, end - delta));
            }
        };

        // 가격 포맷(blur 시 1,000 단위 콤마 표시)
        const formatPriceOnBlur = () => {
            if (!priceInput) return;
            if (!priceInput.value) return;
            const n = parseInt(priceInput.value, 10);
            if (Number.isFinite(n)) {
                priceInput.value = n.toLocaleString();
            }
        };

        // 포맷 해제(제출 직전 콤마 제거)
        const unformatPriceBeforeSubmit = () => {
            if (!priceInput) return;
            priceInput.value = priceInput.value.replace(/[^\d]/g, '');
        };

        // 이벤트 바인딩
        [nameInput, descInput].forEach((el) => {
            el.addEventListener('input', () => { toggleActive(el); updateButton(); });
            toggleActive(el);
        });

        if (priceInput) {
            priceInput.addEventListener('input', () => { sanitizePrice(); toggleActive(priceInput); updateButton(); });
            priceInput.addEventListener('focus', () => {
                priceInput.value = priceInput.value.replace(/[^\d]/g, '');
            });
            priceInput.addEventListener('blur', () => { formatPriceOnBlur(); toggleActive(priceInput); updateButton(); });
            toggleActive(priceInput);
        }

        if (mainCheck && mainLabel) {
            const updateMainLabel = () => mainLabel.classList.toggle('active', mainCheck.checked);
            mainCheck.addEventListener('change', updateMainLabel);
            updateMainLabel();
        }

        // 제출 이벤트
        form.addEventListener('submit', (e) => {
            if (btn.dataset.enabled !== '1') {
                e.preventDefault();
                alert('상품명, 설명, 가격을 모두 입력해 주세요.');
                return;
            }
            unformatPriceBeforeSubmit();
        });

        // 최초 상태 평가
        updateButton();
    });
    </script>
</html>
