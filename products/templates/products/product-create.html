{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DDAL-LANG</title>
        <link rel="stylesheet" href="{% static 'css/OwnerStoreRegistration.css'%}" />
    </head>
    <body>
        <main>
            <div id="container">
                <header>
                    <a href="{% url 'products:product-list' store.id %}" id="change">
                        <img src="{% static 'img/leftside.svg'%}" class="sideClick"/>
                    </a>
                    <p id="title">상품 등록/수정</p>
                    <p> </p>
                </header>
                <div id="containerBox">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <!-- 상품명 -->
                        <input type="text" name="name" placeholder="상품명"
                                class="inputBox"
                                value="{{ form.instance.name|default_if_none:'' }}" />

                        <!-- 상품 설명 -->
                        <input type="text" name="description" placeholder="상품 설명"
                                class="inputBox"
                                value="{{ form.instance.description|default_if_none:'' }}" />

                        <!-- 가격 (JS에서 콤마 넣고, submit 직전에 콤마 제거) -->
                        <input type="text" name="price" placeholder="가격"
                                class="inputBox"
                                value="{% if form.instance.price %}{{ form.instance.price }}{% endif %}" />

                        <!-- 이미지 -->
                        {% comment %} <div class="box">
                            <p class="boxTitle">이미지(선택)</p>
                            <input type="file" name="image" accept="image/*" class="timeStyle" />
                            {% if form.instance.image %}
                            <div style="margin-top:8px;">
                                현재 이미지: <a href="{{ form.instance.image.url }}" target="_blank">보기</a>
                            </div>
                            {% endif %}
                        </div> {% endcomment %}

                        <!-- 대표 상품 -->
                        <label class="checkboxLabel">
                            <input type="checkbox" name="is_main"
                                {% if form.instance.is_main %}checked{% endif %} />
                            대표 상품 (1개만 가능합니다)
                        </label>

                        <button type="button" class="btn" id="btn">확인</button>

                        <!-- (선택) 에러 표시 -->
                        {% if form.errors %}
                            <div style="color:#d00; margin-top:8px;">
                            {{ form.errors }}
                            </div>
                        {% endif %}
                        </form>
                </div>
            </div>
        </main>
    </body>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form');
    const btn  = document.getElementById('btn');

    // 입력 요소들
    const [nameInput, descInput, priceInput] = document.querySelectorAll('.inputBox');
    const mainLabel = document.querySelector('.checkboxLabel');
    const mainCheck = mainLabel ? mainLabel.querySelector('input[type="checkbox"]') : null;

    // 값 있는지 확인
    const hasValue = (el) => el && el.value.trim() !== '';

    // 필드 .active 토글
    const toggleActive = (el) => {
        if (!el) return;
        el.classList.toggle('active', hasValue(el));
    };

    // 버튼 활성화 조건: 상품명/설명/가격 모두 채움
    const updateButton = () => {
        const ok = hasValue(nameInput) && hasValue(descInput) && hasValue(priceInput);
        btn.classList.toggle('active', ok);
        btn.dataset.enabled = ok ? '1' : '0';
    };

    // 가격 숫자만 입력(실시간)
    const sanitizePrice = () => {
        if (!priceInput) return;
        const start = priceInput.selectionStart;
        const end   = priceInput.selectionEnd;
        const before = priceInput.value;
        // 숫자만 남김
        let onlyDigits = before.replace(/[^\d]/g, '');
        // 불필요한 선행 0 제거 (단, 값이 "0" 하나만 남는 경우는 허용)
        if (onlyDigits.length > 1) {
        onlyDigits = String(parseInt(onlyDigits, 10) || '');
        }
        if (before !== onlyDigits) {
        priceInput.value = onlyDigits;
        // 커서 위치 복구 시도
        const delta = before.length - onlyDigits.length;
        priceInput.setSelectionRange(Math.max(0, start - delta), Math.max(0, end - delta));
        }
    };

    // 가격 포맷(blur 시 1,000 단위 콤마 표시) — 제출 전엔 다시 숫자로 돌릴게요
    const formatPriceOnBlur = () => {
        if (!priceInput) return;
        if (!priceInput.value) return;
        const n = parseInt(priceInput.value, 10);
        if (Number.isFinite(n)) {
        priceInput.value = n.toLocaleString(); // 12,345
        }
    };

    // 포맷 해제(제출 직전 콤마 제거)
    const unformatPriceBeforeSubmit = () => {
        if (!priceInput) return;
        priceInput.value = priceInput.value.replace(/[^\d]/g, '');
    };

    // 이벤트 바인딩
    [nameInput, descInput].forEach((el) => {
        el.addEventListener('input', () => { toggleActive(el); updateButton(); });
        toggleActive(el);
    });

    if (priceInput) {
        priceInput.addEventListener('input', () => { sanitizePrice(); toggleActive(priceInput); updateButton(); });
        priceInput.addEventListener('focus', () => {
        // 포맷된 상태(12,345)로 포커스 오면 콤마 제거해서 편집하기 쉽게
        priceInput.value = priceInput.value.replace(/[^\d]/g, '');
        });
        priceInput.addEventListener('blur', () => { formatPriceOnBlur(); toggleActive(priceInput); updateButton(); });
        toggleActive(priceInput);
    }

    if (mainCheck && mainLabel) {
        // 체크 여부에 따라 라벨에 .active 주고 싶다면
        const updateMainLabel = () => mainLabel.classList.toggle('active', mainCheck.checked);
        mainCheck.addEventListener('change', updateMainLabel);
        updateMainLabel();
    }

    // 버튼 클릭 → 유효하면 제출
    btn.addEventListener('click', (e) => {
        if (btn.dataset.enabled !== '1') {
        e.preventDefault();
        alert('상품명, 설명, 가격을 모두 입력해 주세요.');
        return;
        }
        // 제출 전 가격의 콤마 제거
        unformatPriceBeforeSubmit();
        if (form) form.submit();
    });

    // 최초 상태 평가
    updateButton();
    });
    </script>
</html>